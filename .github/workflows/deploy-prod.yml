name: CI/CD - IaEditais

on:
  push:
    branches: ["main"]

jobs:

  # ==============================
  # ðŸš¦ CI â€” testa o projeto
  # ==============================
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Instalar dependÃªncias
        run: npm install

      - name: Rodar build para validar
        run: npm run build

      # Se quiser adicionar testes depois:
      # - name: Rodar testes
      #   run: npm run test

  # ==============================
  # ðŸš€ CD â€” sÃ³ roda SE o CI PASSAR
  # ==============================
  cd:
    needs: ci  # ðŸ‘ˆ obrigatÃ³rio: sÃ³ continua se o job 'ci' passar
    runs-on: ubuntu-latest

    steps:

    - name: Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: Configurar chave SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.IA_EDITAIS_SSH }}

    - name: Deploy no servidor via SSH
      run: |
        ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.IP_HOST_IAEDITAIS }} << 'EOF'
          set -e

          echo "ðŸš€ Iniciando deploy via docker-compose..."

          cd /home/ubuntu

          if [ ! -d "iaEditais-prod" ]; then
            git clone -b main https://github.com/rafaelontour/ia_editais_fiocruz.git iaEditais-prod
            cd iaEditais-prod
          else
            cd iaEditais-prod
            git fetch origin main
            git reset --hard origin/main
          fi

          export DOCKER_BUILDKIT=1

          docker compose down --rmi all --remove-orphans || true
          docker compose up -d --build

          echo "âœ… Deploy concluÃ­do com sucesso!"
        EOF
